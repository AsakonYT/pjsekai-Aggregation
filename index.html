<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ—ãƒ­ã‚»ã‚«é›†è¨ˆã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body { 
            background-color: #222; 
            color: #eee; 
            font-family: sans-serif; 
            padding: 20px; 
            margin: 0; 
        }
        
        #main_container {
            position: relative; 
            min-height: 100vh; 
            display: flex;
            flex-direction: column;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
        }

        #result_screen {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #222;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto; 
            
            opacity: 0; 
            transition: opacity 0.5s ease-in-out; 
            pointer-events: none; 
            display: none; 
        }
        
        #result_screen.visible {
            opacity: 1;
            pointer-events: auto; 
        }
        
        h2, h3 { color: #ddd; border-bottom: 2px solid #444; padding-bottom: 5px; margin-top: 30px; }
        .settings-group label { margin-right: 20px; display: inline-block; margin-bottom: 10px; }
        .settings-group input { background-color: #333; border: 1px solid #555; color: #eee; padding: 5px; width: 80px; text-align: center; }
        
        .score-input-area {
            margin-top: 20px; display: grid; grid-template-columns: 100px repeat(5, 1fr); gap: 2px; background-color: #444;
        }
        .row { display: contents; } 
        .header-row .label-col, .header-row .player-col { background-color: #111; font-weight: bold; padding: 8px 5px; text-align: center; }
        .label-col { grid-column: 1; text-align: left; padding: 8px 5px; background-color: #333; }
        .player-score { width: 90%; height: 30px; padding: 0; margin: 4px auto; display: block; text-align: center; background-color: #333; border: 1px solid #555; color: #eee; }
        
        button { padding: 10px 15px; margin-top: 20px; margin-right: 10px; border: none; cursor: pointer; border-radius: 4px; }
        
        #reset_scores_button { background-color: #dc3545; color: white; }
        #show_intermediate_button { background-color: #007bff; color: white; }
        #show_single_song_result { background-color: #00a0a0; color: white; } 
        #confirm_song_score { background-color: #1e7e34; color: white; }
        #show_result_button { background-color: #e3a800; color: white; }
        #show_result_button:disabled { background-color: #555; color: #999; cursor: not-allowed;}
        
        #reset_game_button { background-color: #6c757d; color: white; }
        #undo_song_button { background-color: #ffc107; color: black; }

        #final_result_table { width: 100%; border-collapse: collapse; margin-top: 15px; color: #eee; text-align: center; }
        #final_result_table th, #final_result_table td { border: 1px solid #444; padding: 10px 5px; min-width: 80px; }
        #final_result_table th { background-color: #333; }
        #final_result_table tbody tr td:first-child { font-weight: bold; text-align: left; background-color: #2a2a2a; }
        
        .total-row {
            font-weight: bold;
            background-color: #555;
            color: #ff9900;
            font-size: 1.2em;
        }

        .count-total-row {
            font-weight: bold;
            background-color: #3a3a3a;
            color: #ccc;
            font-size: 1.0em;
        }
        
        .first-place-column-cell {
            background-color: #383818 !important; 
            box-shadow: 0 0 10px rgba(255, 204, 0, 0.5); 
            border-left: 2px solid #ffcc00 !important;
            border-right: 2px solid #ffcc00 !important;
        }
        .total-row .first-place-column-cell {
             background-color: #705500 !important;
        }
        .count-total-row .first-place-column-cell {
             background-color: #505030 !important;
        }
        .single-song-highlight-cell {
             background-color: #383818 !important; 
        }

        .rank-perfect {
            background-image: linear-gradient(to right, #e0b0ff, #ff6b8e); 
            -webkit-background-clip: text;
            color: transparent;
            font-weight: bold;
        }
        .rank-great { color: red; }
        .rank-good { color: deepskyblue; }
        .rank-bad { color: limegreen; } 
        .rank-miss { color: #888; } 

        .hidden-value {
            visibility: hidden; 
        }
        .show-value .hidden-value {
            visibility: visible;
        }
    </style>
</head>
<body>

    <div id="main_container">
        <h2>è¨­å®š</h2>

        <div class="player-name-settings settings-group">
            <h3>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åè¨­å®š</h3>
            <label>P1 åå‰: <input type="text" id="name_1" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1"></label>
            <label>P2 åå‰: <input type="text" id="name_2" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2"></label>
            <label>P3 åå‰: <input type="text" id="name_3" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼3"></label>
            <label>P4 åå‰: <input type="text" id="name_4" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼4"></label>
            <label>P5 åå‰: <input type="text" id="name_5" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼5"></label>
        </div>

        <div class="total-songs-settings settings-group">
            <h3>ã‚²ãƒ¼ãƒ è¨­å®š</h3>
            <label>ç·æ›²æ•°: <input type="number" id="total_songs" value="5" min="1"></label>
        </div>

        <div class="scoring-settings settings-group">
            <h3>é…ç‚¹è¨­å®š</h3>
            <label>Perfect: <input type="number" id="score_perfect" value="3"></label>
            <label>Great: <input type="number" id="score_great" value="2"></label>
            <label>Good: <input type="number" id="score_good" value="1"></label>
            <label>Bad: <input type="number" id="score_bad" value="0"></label>
            <label>Miss: <input type="number" id="score_miss" value="0"></label>
        </div>
        
        <div id="input_screen" class="screen">
            <h3>æ¡ç‚¹å…¥åŠ› (<span id="current_song_display">1</span> æ›²ç›® / å…¨ <span id="total_songs_display">5</span> æ›²)</h3>
            
            <button id="reset_scores_button">ç¾åœ¨ã®å…¥åŠ›ã‚’ã™ã¹ã¦0ã«æˆ»ã™</button>
            <button id="show_intermediate_button">ç¾åœ¨ã®å›æ•°ã‚’è¡¨ç¤º</button>
            <button id="show_single_song_result">ã“ã®æ›²ã®çµæœã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>

            <hr style="margin: 20px 0; border-color: #444;"> 
            <button id="confirm_song_score">âœ… ã“ã®æ›²ã®ã‚¹ã‚³ã‚¢ã‚’ç¢ºå®šã—ã€æ¬¡ã®æ›²ã¸é€²ã‚€</button>
            <button id="undo_song_button">â†©ï¸ ä¸€æ›²å‰ã«æˆ»ã‚‹ (æœ€æ–°ã®ã‚¹ã‚³ã‚¢ã‚’å‰Šé™¤)</button>
            <button id="show_result_button" disabled>ğŸ† å…¨æ›²ã®ç·åˆçµæœã‚’è¡¨ç¤º</button>

            <hr style="margin: 20px 0; border-color: #444;">
            <button id="reset_game_button">ğŸ”„ ã‚²ãƒ¼ãƒ ã‚’æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™ (æ›²æ•°ã¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ)</button>


            <div class="score-input-area">
                
                <div class="row header-row">
                    <span class="label-col">åˆ¤å®š</span>
                    <span class="player-col" id="header_p1_name">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1</span>
                    <span class="player-col" id="header_p2_name">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2</span>
                    <span class="player-col" id="header_p3_name">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼3</span>
                    <span class="player-col" id="header_p4_name">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼4</span>
                    <span class="player-col" id="header_p5_name">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼5</span>
                </div>

                <div class="row"><span class="label-col rank-perfect">Perfect</span>
                    <input type="number" class="player-score" data-player="1" data-rank="perfect" value="0" min="0">
                    <input type="number" class="player-score" data-player="2" data-rank="perfect" value="0" min="0">
                    <input type="number" class="player-score" data-player="3" data-rank="perfect" value="0" min="0">
                    <input type="number" class="player-score" data-player="4" data-rank="perfect" value="0" min="0">
                    <input type="number" class="player-score" data-player="5" data-rank="perfect" value="0" min="0">
                </div>
                <div class="row"><span class="label-col rank-great">Great</span>
                    <input type="number" class="player-score" data-player="1" data-rank="great" value="0" min="0">
                    <input type="number" class="player-score" data-player="2" data-rank="great" value="0" min="0">
                    <input type="number" class="player-score" data-player="3" data-rank="great" value="0" min="0">
                    <input type="number" class="player-score" data-player="4" data-rank="great" value="0" min="0">
                    <input type="number" class="player-score" data-player="5" data-rank="great" value="0" min="0">
                </div>
                <div class="row"><span class="label-col rank-good">Good</span>
                    <input type="number" class="player-score" data-player="1" data-rank="good" value="0" min="0">
                    <input type="number" class="player-score" data-player="2" data-rank="good" value="0" min="0">
                    <input type="number" class="player-score" data-player="3" data-rank="good" value="0" min="0">
                    <input type="number" class="player-score" data-player="4" data-rank="good" value="0" min="0">
                    <input type="number" class="player-score" data-player="5" data-rank="good" value="0" min="0">
                </div>
                <div class="row"><span class="label-col rank-bad">Bad</span>
                    <input type="number" class="player-score" data-player="1" data-rank="bad" value="0" min="0">
                    <input type="number" class="player-score" data-player="2" data-rank="bad" value="0" min="0">
                    <input type="number" class="player-score" data-player="3" data-rank="bad" value="0" min="0">
                    <input type="number" class="player-score" data-player="4" data-rank="bad" value="0" min="0">
                    <input type="number" class="player-score" data-player="5" data-rank="bad" value="0" min="0">
                </div>
                <div class="row"><span class="label-col rank-miss">Miss</span>
                    <input type="number" class="player-score" data-player="1" data-rank="miss" value="0" min="0">
                    <input type="number" class="player-score" data-player="2" data-rank="miss" value="0" min="0">
                    <input type="number" class="player-score" data-player="3" data-rank="miss" value="0" min="0">
                    <input type="number" class="player-score" data-player="4" data-rank="miss" value="0" min="0">
                    <input type="number" class="player-score" data-player="5" data-rank="miss" value="0" min="0">
                </div>
            </div>
            
            <div id="intermediate_result_container">
            </div>
        </div>


        <div id="result_screen" class="screen">
            <h3 id="result_title">ç·åˆçµæœ</h3>
            <button id="show_final_values_button" style="margin-bottom: 20px;">å›æ•°ã¨åˆè¨ˆã®æ•°å€¤ã‚’è¡¨ç¤º</button>
            <div id="final_result_table_container">
            </div>
            <button id="back_to_input">å…¥åŠ›ç”»é¢ã«æˆ»ã‚‹</button>
        </div>
    </div>

    <script>
        
        const RANKS = ['perfect', 'great', 'good', 'bad', 'miss']; 
        const NUM_PLAYERS = 5;

        const DEFAULT_NAMES = ["ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1", "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2", "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼3", "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼4", "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼5"];
        const DEFAULT_SONGS = 5;
        const DEFAULT_SCORES = { 
            'perfect': 3,
            'great': 2,
            'good': 1,
            'bad': 0,
            'miss': 0
        };
        
        let allSongsData = [];
        let currentSongNumber = 1; 

        const RANK_CLASSES = {
            'perfect': 'rank-perfect',
            'great': 'rank-great',
            'good': 'rank-good',
            'bad': 'rank-bad',
            'miss': 'rank-miss'
        };

        document.addEventListener('DOMContentLoaded', () => {
            
            document.getElementById('result_screen').style.display = 'none';
            
            const totalSongsInput = document.getElementById('total_songs');
            const totalSongsDisplay = document.getElementById('total_songs_display');
            
            const updateTotalSongs = () => {
                const total = parseInt(totalSongsInput.value) || 1;
                totalSongsInput.value = total;
                totalSongsDisplay.textContent = total;
                updateOverallResultButtonStatus();
            };
            totalSongsInput.addEventListener('change', updateTotalSongs);
            updateTotalSongs(); 
            
            document.getElementById('current_song_display').textContent = currentSongNumber;


            document.getElementById('show_result_button').addEventListener('click', calculateAndShowOverallResults);
            document.getElementById('show_intermediate_button').addEventListener('click', calculateIntermediateResults); 
            document.getElementById('show_single_song_result').addEventListener('click', calculateAndShowSingleSongResult); 
            document.getElementById('back_to_input').addEventListener('click', showInputScreen);
            document.getElementById('reset_scores_button').addEventListener('click', resetCurrentScores); 
            document.getElementById('confirm_song_score').addEventListener('click', confirmSongScore);
            document.getElementById('show_final_values_button').addEventListener('click', showFinalValues);
            document.getElementById('reset_game_button').addEventListener('click', resetGame);
            document.getElementById('undo_song_button').addEventListener('click', undoSong);


            for (let i = 1; i <= NUM_PLAYERS; i++) {
                const inputElement = document.getElementById(`name_${i}`);
                const headerElement = document.getElementById(`header_p${i}_name`);
                headerElement.textContent = inputElement.value || `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i}`;
                inputElement.addEventListener('input', (event) => {
                    headerElement.textContent = event.target.value || `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i}`;
                });
            }

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && document.getElementById('result_screen').classList.contains('visible')) {
                    showInputScreen();
                }
            });
        });
        
        function resetGame() {
            if (!confirm("ç¾åœ¨ã®æ›²ã®ãƒ‡ãƒ¼ã‚¿ã¨ã€ã™ã¹ã¦ã®è¨­å®šï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã€ç·æ›²æ•°ã€é…ç‚¹ï¼‰ã‚’åˆæœŸå€¤ã«æˆ»ã—ã¾ã™ã€‚æœ¬å½“ã«ã‚²ãƒ¼ãƒ ã‚’æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ")) {
                return;
            }
            
            allSongsData = [];
            currentSongNumber = 1;
            document.getElementById('current_song_display').textContent = currentSongNumber;
            updateOverallResultButtonStatus();
            resetCurrentScores();
            
            for (let i = 1; i <= NUM_PLAYERS; i++) {
                const inputElement = document.getElementById(`name_${i}`);
                const headerElement = document.getElementById(`header_p${i}_name`);
                inputElement.value = DEFAULT_NAMES[i - 1];
                headerElement.textContent = DEFAULT_NAMES[i - 1];
            }

            const totalSongsInput = document.getElementById('total_songs');
            totalSongsInput.value = DEFAULT_SONGS;
            document.getElementById('total_songs_display').textContent = DEFAULT_SONGS;

            RANKS.forEach(rank => {
                document.getElementById(`score_${rank}`).value = DEFAULT_SCORES[rank];
            });


            alert("ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã¨ã™ã¹ã¦ã®è¨­å®šãŒåˆæœŸå€¤ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚");
        }

        function undoSong() {
            if (allSongsData.length === 0) {
                alert("ã¾ã ç¢ºå®šã•ã‚ŒãŸã‚¹ã‚³ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }

            if (!confirm(`ç›´å‰ã® ${currentSongNumber - 1} æ›²ç›®ã®ã‚¹ã‚³ã‚¢ã‚’å‰Šé™¤ã—ã€ä¸€æ›²å‰ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            allSongsData.pop(); 
            currentSongNumber--;
            document.getElementById('current_song_display').textContent = currentSongNumber;
            updateOverallResultButtonStatus();
            resetCurrentScores();
            alert(`${currentSongNumber} æ›²ç›®ã®å…¥åŠ›ã«æˆ»ã‚Šã¾ã—ãŸã€‚`);
        }

        function updateOverallResultButtonStatus() {
            const totalSongs = parseInt(document.getElementById('total_songs').value) || 1;
            const overallButton = document.getElementById('show_result_button');
            
            if (allSongsData.length === totalSongs && totalSongs > 0) {
                overallButton.disabled = false;
            } else {
                overallButton.disabled = true;
            }
        }

        function resetCurrentScores() {
            const scoreInputs = document.querySelectorAll('.player-score');
            scoreInputs.forEach(input => {
                input.value = 0;
            });

            document.getElementById('intermediate_result_container').style.display = 'none';
            if (document.getElementById('result_screen').classList.contains('visible')) {
                showInputScreen();
            }
        }

        function confirmSongScore() {
            const totalSongs = parseInt(document.getElementById('total_songs').value) || 1;
            
            if (currentSongNumber > totalSongs) {
                alert(`ç·æ›²æ•°(${totalSongs}æ›²)ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚æ¬¡ã®æ›²ã¸é€²ã‚€å‰ã«ã€ç·åˆçµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
                return;
            }

            const currentScores = getPlayerData(); 
            const totalScoreSum = currentScores.reduce((sum, p) => sum + p.totalScore, 0);
            if (totalScoreSum === 0 && !confirm("ã“ã®æ›²ã®ã‚¹ã‚³ã‚¢ã¯å…¨ã¦0ç‚¹ã§ã™ãŒã€ç¢ºå®šã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
                return;
            }

            const songData = {
                song: currentSongNumber,
                scores: currentScores.map(p => ({
                    id: p.id,
                    name: p.name,
                    counts: p.counts,
                    totalScore: p.totalScore
                }))
            };

            allSongsData.push(songData); 

            let alertMessage = `${currentSongNumber}æ›²ç›®ã®ã‚¹ã‚³ã‚¢ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼\n\n`;
            
            const overallPlayerData = getOverallPlayerData(true); 
            
            if (currentSongNumber < totalSongs) {
                 alertMessage += `æ¬¡ã® ${currentSongNumber + 1} æ›²ç›®ã¸é€²ã¿ã¾ã™ã€‚\n\n`;
            } else {
                alertMessage += `ã“ã‚Œã§ç·æ›²æ•°ã«é”ã—ã¾ã—ãŸï¼\nã€ŒğŸ† å…¨æ›²ã®ç·åˆçµæœã‚’è¡¨ç¤ºã€ãƒœã‚¿ãƒ³ãŒæŠ¼ã›ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚`;
            }

            overallPlayerData.forEach(p => {
                const totalScore = overallPlayerData.find(data => data.id === p.id).totalScore;
                alertMessage += `${p.name}: ç·åˆ ${totalScore}ç‚¹\n`;
            });
            
            alert(alertMessage);
            
            currentSongNumber++; 
            document.getElementById('current_song_display').textContent = currentSongNumber;
            updateOverallResultButtonStatus();
            resetCurrentScores(); 
        }

        function getPlayerData() {
             const scores = {};
            RANKS.forEach(rank => {
                scores[rank] = parseInt(document.getElementById(`score_${rank}`).value) || 0;
            });

            const playerNames = {};
            for (let i = 1; i <= NUM_PLAYERS; i++) {
                playerNames[i] = document.getElementById(`name_${i}`).value || `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i}`;
            }

            const allPlayerData = [];

            for (let p = 1; p <= NUM_PLAYERS; p++) {
                let totalScore = 0;
                const counts = {};

                RANKS.forEach(rank => {
                    const inputElement = document.querySelector(`.player-score[data-player="${p}"][data-rank="${rank}"]`);
                    const count = parseInt(inputElement ? inputElement.value : 0) || 0; 
                    counts[rank] = count;
                    
                    totalScore += count * scores[rank];
                });

                allPlayerData.push({
                    id: p,
                    name: playerNames[p],
                    counts: counts,
                    totalScore: totalScore
                });
            }
            return allPlayerData;
        }


        function calculateIntermediateResults() {
             const allPlayerData = getPlayerData();
            const container = document.getElementById('intermediate_result_container');
            container.innerHTML = ''; 

            const table = document.createElement('table');
            table.id = 'intermediate_result_table';

            const thead = table.createTHead();
            let headerRow = thead.insertRow();
            headerRow.insertCell().textContent = 'åˆ¤å®š';

            allPlayerData.forEach((data) => {
                headerRow.insertCell().textContent = data.name;
            });
            
            const tbody = table.createTBody();

            RANKS.forEach(rank => {
                let row = tbody.insertRow();
                
                let rankCell = row.insertCell();
                rankCell.textContent = rank.charAt(0).toUpperCase() + rank.slice(1);
                rankCell.classList.add(RANK_CLASSES[rank]); 
                
                allPlayerData.forEach(data => {
                    let cell = row.insertCell();
                    cell.textContent = data.counts[rank];
                });
            });

            let totalRow = tbody.insertRow();
            totalRow.classList.add('total-row');
            
            totalRow.insertCell().textContent = 'TOTAL';
            
            allPlayerData.forEach(data => {
                let cell = totalRow.insertCell();
                cell.textContent = data.totalScore;
                cell.style.color = '#ff9900'; 
            });

            container.appendChild(table);
            container.style.display = 'block'; 
        }

        function showFinalValues() {
            const tableContainer = document.getElementById('final_result_table_container');
            
            tableContainer.classList.add('show-value');
            document.getElementById('show_final_values_button').style.display = 'none';

            
            document.querySelectorAll('.first-place-column-cell, .single-song-highlight-cell').forEach(cell => {
                cell.classList.remove('first-place-column-cell', 'single-song-highlight-cell');
            });
            
            const title = document.getElementById('result_title').textContent;
            let dataForHighlight;
            let highlightType;

            if (title.includes('å˜ä½“çµæœ')) {
                dataForHighlight = getPlayerData();
                highlightType = 'single_song';
            } else {
                dataForHighlight = getOverallPlayerData();
                highlightType = 'overall';
            }
            
            highlightWinners(dataForHighlight, highlightType);
        }

        function highlightWinners(data, type) {
            if (data.length === 0) return;

            const sortedData = [...data].sort((a, b) => b.totalScore - a.totalScore);
            const firstPlaceScore = sortedData[0].totalScore > 0 ? sortedData[0].totalScore : -1; 
            
            const firstPlacePlayerIds = data
                .filter(pData => pData.totalScore === firstPlaceScore)
                .map(pData => pData.id);

            if (firstPlacePlayerIds.length > 0) {
                const table = document.getElementById('final_result_table');
                if (table) {
                    const allRows = table.querySelectorAll('tbody tr');

                    data.forEach((pData, index) => {
                        if (firstPlacePlayerIds.includes(pData.id)) {
                            const columnIndex = index + 1; 

                            allRows.forEach(row => {
                                const cell = row.cells[columnIndex];
                                
                                if (cell) {
                                    if (type === 'overall') {
                                        if (row.matches('.total-row') || row.matches('.count-total-row')) {
                                             cell.classList.add('first-place-column-cell');
                                        }
                                    } else if (type === 'single_song') {
                                        if (row.matches('.total-row') || !row.querySelector('td:first-child').classList.contains('total-row')) {
                                            if (row.matches('.total-row')) {
                                                cell.classList.add('first-place-column-cell'); 
                                            } else {
                                                cell.classList.add('single-song-highlight-cell'); 
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    });
                }
            }
        }

        function calculateAndShowSingleSongResult() {
            const allPlayerData = getPlayerData();
            
            const songTitle = `æ›²ç›® ${currentSongNumber} ã®å˜ä½“çµæœ`;

            generateResultTable(allPlayerData, songTitle, 'single_song');
            
            toggleScreens(false);
        }

        function calculateAndShowOverallResults() {
            if (allSongsData.length === 0) {
                alert("ã¾ã ç¢ºå®šã•ã‚ŒãŸæ›²ã®ã‚¹ã‚³ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }
            
            const overallPlayerData = getOverallPlayerData();
            
            generateResultTable(overallPlayerData, 'ç·åˆçµæœ', 'overall');
            
            toggleScreens(false);
        }

        function getOverallPlayerData() {
            const overallResults = {};

            for (let p = 1; p <= NUM_PLAYERS; p++) {
                overallResults[p] = {
                    id: p,
                    name: document.getElementById(`name_${p}`).value || `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${p}`,
                    totalScore: 0,
                    songScores: [],
                    totalCounts: {}
                };
                RANKS.forEach(rank => overallResults[p].totalCounts[rank] = 0);
            }

            allSongsData.forEach((song) => {
                song.scores.forEach(playerScore => {
                    const pId = playerScore.id;
                    overallResults[pId].totalScore += playerScore.totalScore; 
                    
                    overallResults[pId].songScores.push({
                        song: song.song,
                        score: playerScore.totalScore
                    });

                    RANKS.forEach(rank => {
                        overallResults[pId].totalCounts[rank] += playerScore.counts[rank];
                    });
                });
            });
            
            return Object.values(overallResults);
        }

        function generateResultTable(data, title, type) {
            const container = document.getElementById('final_result_table_container');
            container.innerHTML = ''; 
            document.getElementById('result_title').textContent = title;

            container.classList.remove('show-value'); 
            document.getElementById('show_final_values_button').style.display = 'block';

            const table = document.createElement('table');
            table.id = 'final_result_table';

            const thead = table.createTHead();
            let headerRow = thead.insertRow();
            headerRow.insertCell().textContent = (type === 'overall') ? 'åˆ¤å®š/ç·åˆ' : 'åˆ¤å®š';

            data.forEach((pData) => {
                headerRow.insertCell().textContent = pData.name;
            });
            
            const tbody = table.createTBody();

            if (type === 'overall') {
                
                RANKS.forEach(rank => {
                    let row = tbody.insertRow();
                    row.classList.add('count-total-row');
                    
                    let rankCell = row.insertCell();
                    rankCell.textContent = `${rank.charAt(0).toUpperCase() + rank.slice(1)} å›æ•°`;
                    
                    data.forEach(pData => {
                        let cell = row.insertCell();
                        let valueSpan = document.createElement('span');
                        valueSpan.classList.add('hidden-value');
                        valueSpan.textContent = pData.totalCounts[rank]; 
                        cell.appendChild(valueSpan);
                    });
                });

                let totalRow = tbody.insertRow();
                totalRow.classList.add('total-row');
                
                totalRow.insertCell().textContent = 'ç·åˆ TOTAL';
                
                data.forEach(pData => {
                    let cell = totalRow.insertCell();
                    let valueSpan = document.createElement('span');
                    valueSpan.classList.add('hidden-value');
                    valueSpan.textContent = pData.totalScore;
                    cell.appendChild(valueSpan);
                });

            } else if (type === 'single_song') {
                
                RANKS.forEach(rank => {
                    let row = tbody.insertRow();
                    
                    let rankCell = row.insertCell();
                    rankCell.textContent = rank.charAt(0).toUpperCase() + rank.slice(1);
                    rankCell.classList.add(RANK_CLASSES[rank]); 
                    
                    data.forEach(playerData => {
                        let cell = row.insertCell();
                        let valueSpan = document.createElement('span');
                        valueSpan.classList.add('hidden-value');
                        valueSpan.textContent = playerData.counts[rank];
                        cell.appendChild(valueSpan);
                    });
                });

                let totalRow = tbody.insertRow();
                totalRow.classList.add('total-row');

                totalRow.insertCell().textContent = 'TOTAL';
                
                data.forEach(pData => {
                    let cell = totalRow.insertCell();
                    let valueSpan = document.createElement('span');
                    valueSpan.classList.add('hidden-value');
                    valueSpan.textContent = pData.totalScore;
                    cell.appendChild(valueSpan);
                });
            }

            container.appendChild(table);
        }

        function showInputScreen() {
            toggleScreens(true);
            document.getElementById('intermediate_result_container').style.display = 'none';
        }

        function toggleScreens(showInput) {
            const inputScreen = document.getElementById('input_screen');
            const resultScreen = document.getElementById('result_screen');

            if (!showInput) {
                resultScreen.style.display = 'block'; 
                inputScreen.style.display = 'none'; 
                
                setTimeout(() => {
                    resultScreen.classList.add('visible');
                }, 10);
            } else {
                resultScreen.classList.remove('visible');
                
                setTimeout(() => {
                    resultScreen.style.display = 'none'; 
                    inputScreen.style.display = 'block'; 
                }, 500); 
            }
        }
    </script>
</body>
</html>